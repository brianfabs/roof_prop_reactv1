<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roofing Proposal - Global Roofing</title>
    <link rel="stylesheet" href="main_premium.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="proposal-view">
        <!-- Premium Header Section -->
        <div class="proposal-header">
            <img src="https://getglobalroofing.com/wp-content/uploads/2025/05/Logo512.png" alt="Global Roofing" class="company-logo">
            <h1 class="proposal-title">Your Roofing Investment Proposal</h1>
            <p class="proposal-subtitle">Professional roofing solutions tailored for your home</p>
            
            <div class="trust-indicators">
                <div class="trust-badge">
                    <svg class="trust-badge-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Licensed & Insured
                </div>
                <div class="trust-badge">
                    <svg class="trust-badge-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    A+ BBB Rating
                </div>
                <div class="trust-badge">
                    <svg class="trust-badge-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    25+ Years Experience
                </div>
            </div>
        </div>

        <!-- Customer Information Section -->
        <div class="proposal-section" id="customer-info-section">
            <div class="section-header">
                <h3 class="section-title">Project Overview</h3>
                <p class="section-subtitle">Your personalized roofing solution details</p>
            </div>
            <div id="customer-info">
                <!-- Customer info will be populated by JavaScript -->
            </div>
        </div>

        <!-- Roofing Options Section -->
        <div class="proposal-section">
            <div class="section-header">
                <h3 class="section-title">Your Roofing Options</h3>
                <p class="section-subtitle">Choose the perfect solution for your home and budget</p>
            </div>
            <div id="options-container">
                <!-- Options will be populated by JavaScript -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading your personalized proposal...</p>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="error-container" style="display: none;">
            <!-- Error messages will be displayed here -->
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        const proposalsCol = firebase.firestore().collection('proposals');
        const optionsCol = firebase.firestore().collection('roofing_options');
        const loanOptionsCol = firebase.firestore().collection('loan_options');

        // Fallback pricing if options don't have pricing data
        const FALLBACK_PRICING = {
            good: 625,
            better: 770,
            best: 850
        };

        /**
         * Calculate monthly payment for loan
         */
        function calculateMonthlyPayment(principal, annualRate, years) {
            if (annualRate === 0) return principal / (years * 12);
            
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                   (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        /**
         * Get proposal ID from URL parameters
         */
        function getProposalId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        /**
         * Check authentication
         */
        function checkAuth() {
            const user = localStorage.getItem('loggedInUser');
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        /**
         * Display error message
         */
        function displayError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<h3>Error</h3><p>${message}</p>`;
            errorContainer.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        /**
         * Load proposal data from Firestore
         */
        async function loadProposal(proposalId) {
            try {
                console.log('Loading proposal with ID:', proposalId);
                const proposalDoc = await proposalsCol.doc(proposalId).get();
                
                if (!proposalDoc.exists) {
                    throw new Error('Proposal not found');
                }
                
                const proposalData = proposalDoc.data();
                console.log('Proposal data loaded:', proposalData);
                return proposalData;
            } catch (error) {
                console.error('Error loading proposal:', error);
                throw error;
            }
        }

        /**
         * Load roofing options from Firestore
         */
        async function loadRoofingOptions() {
            try {
                console.log('Loading roofing options...');
                
                const [goodDoc, betterDoc, bestDoc] = await Promise.all([
                    optionsCol.doc('good').get(),
                    optionsCol.doc('better').get(),
                    optionsCol.doc('best').get()
                ]);
                
                const options = {};
                
                if (goodDoc.exists) {
                    options.good = goodDoc.data();
                    console.log('Good option loaded:', options.good);
                }
                
                if (betterDoc.exists) {
                    options.better = betterDoc.data();
                    console.log('Better option loaded:', options.better);
                }
                
                if (bestDoc.exists) {
                    options.best = bestDoc.data();
                    console.log('Best option loaded:', options.best);
                }
                
                if (Object.keys(options).length === 0) {
                    console.log('No roofing options found, creating defaults...');
                    await createDefaultOptions();
                    return await loadRoofingOptions();
                }
                
                if (!options.good || !options.better || !options.best) {
                    console.log('Some roofing options missing, creating missing ones...');
                    await createMissingOptions(options);
                    return await loadRoofingOptions();
                }
                
                return options;
            } catch (error) {
                console.error('Error loading roofing options:', error);
                throw error;
            }
        }

        /**
         * Load loan options from Firestore
         */
        async function loadLoanOptions() {
            try {
                console.log('Loading loan options...');
                const snapshot = await loanOptionsCol.get();
                
                const loanOptions = [];
                snapshot.forEach(doc => {
                    loanOptions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by loan term
                loanOptions.sort((a, b) => a.years - b.years);
                
                console.log('Loan options loaded:', loanOptions);
                return loanOptions;
            } catch (error) {
                console.error('Error loading loan options:', error);
                return []; // Return empty array if no loan options
            }
        }

        /**
         * Create missing roofing options
         */
        async function createMissingOptions(existingOptions) {
            const defaultOptions = {
                good: {
                    type: 'good',
                    title: 'Essential Quality',
                    description: 'Reliable and affordable roofing solution with quality materials that provide excellent protection for your home.',
                    warranty: '10-year manufacturer warranty on materials, 2-year workmanship warranty',
                    image: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=200&fit=crop',
                    pricePerSquare: 625.00
                },
                better: {
                    type: 'better',
                    title: 'Premium Quality',
                    description: 'Enhanced roofing system with superior materials and advanced installation techniques for long-lasting durability.',
                    warranty: '20-year manufacturer warranty on materials, 5-year workmanship warranty',
                    image: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=400&h=200&fit=crop',
                    pricePerSquare: 770.00
                },
                best: {
                    type: 'best',
                    title: 'Elite Quality',
                    description: 'Top-of-the-line roofing system with premium materials, cutting-edge technology, and expert craftsmanship.',
                    warranty: '30-year manufacturer warranty on materials, 10-year workmanship warranty',
                    image: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=200&fit=crop',
                    pricePerSquare: 850.00
                }
            };
            
            const batch = firebase.firestore().batch();
            
            ['good', 'better', 'best'].forEach(type => {
                if (!existingOptions[type]) {
                    const docRef = optionsCol.doc(type);
                    batch.set(docRef, defaultOptions[type]);
                    console.log(`Creating missing ${type} option`);
                }
            });
            
            await batch.commit();
            console.log('Missing roofing options created');
        }

        /**
         * Create default roofing options if none exist
         */
        async function createDefaultOptions() {
            return await createMissingOptions({});
        }

        /**
         * Display customer information in premium card layout
         */
        function displayCustomerInfo(proposal) {
            const customerInfoDiv = document.getElementById('customer-info');
            const createdDate = proposal.createdAt && proposal.createdAt.toDate ? 
                proposal.createdAt.toDate().toLocaleDateString() : 'Today';
            
            customerInfoDiv.innerHTML = `
                <div class="customer-info-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <svg class="info-card-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                            <h4 class="info-card-title">Customer Details</h4>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${proposal.customerName || 'Unknown'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Property Address:</span>
                            <span class="info-value">${proposal.address || 'No address provided'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Roof Size:</span>
                            <span class="info-value">${proposal.squares || 0} squares</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <svg class="info-card-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                            </svg>
                            <h4 class="info-card-title">Project Timeline</h4>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Proposal Date:</span>
                            <span class="info-value">${createdDate}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Estimated Start:</span>
                            <span class="info-value">Within 2-3 weeks</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Project Duration:</span>
                            <span class="info-value">1-3 days</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: var(--spacing-xl);">
                    <a href="edit_proposal.html?id=${getProposalId()}" class="btn btn-secondary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                        </svg>
                        Edit Proposal Details
                    </a>
                </div>
            `;
        }

        /**
         * Generate premium financing section
         */
        function generateFinancingSection(loanOptions, totalPrice, optionType) {
            if (!loanOptions || loanOptions.length === 0) {
                return '<p class="text-muted">No financing options available at this time.</p>';
            }
            
            const principal = parseFloat(totalPrice.replace(/[$,]/g, ''));
            
            let financingHTML = `
                <div class="financing-section">
                    <div class="financing-header">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"></path>
                        </svg>
                        <h6 class="financing-title">Flexible Financing Options</h6>
                    </div>
                    <select id="loan-select-${optionType}" class="financing-select" onchange="updateLoanDisplay('${optionType}', ${principal})">
                        <option value="">Choose your payment plan...</option>
            `;
            
            loanOptions.forEach((loan, index) => {
                const monthlyPayment = calculateMonthlyPayment(principal, loan.rate, loan.years);
                const formattedPayment = monthlyPayment.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });
                
                financingHTML += `
                    <option value="${index}" data-payment="${monthlyPayment}" data-years="${loan.years}" data-rate="${loan.rate}">
                        ${loan.name} - ${formattedPayment}/month (${loan.years} years)
                    </option>
                `;
            });
            
            financingHTML += `
                    </select>
                    <div id="loan-details-${optionType}" class="loan-details" style="display: none;">
                        <!-- Loan details will be displayed here -->
                    </div>
                </div>
            `;
            
            return financingHTML;
        }

        /**
         * Update loan display when option is selected
         */
        function updateLoanDisplay(optionType, principal) {
            const select = document.getElementById(`loan-select-${optionType}`);
            const detailsDiv = document.getElementById(`loan-details-${optionType}`);
            
            if (select.value === '') {
                detailsDiv.style.display = 'none';
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            const monthlyPayment = parseFloat(selectedOption.getAttribute('data-payment'));
            const years = parseInt(selectedOption.getAttribute('data-years'));
            const rate = parseFloat(selectedOption.getAttribute('data-rate'));
            
            const totalPayments = monthlyPayment * years * 12;
            const totalInterest = totalPayments - principal;
            
            detailsDiv.innerHTML = `
                <div class="loan-details-grid">
                    <div class="loan-detail-item">
                        <div class="loan-detail-label">Monthly Payment</div>
                        <div class="loan-detail-value">${monthlyPayment.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                    </div>
                    <div class="loan-detail-item">
                        <div class="loan-detail-label">Total Interest</div>
                        <div class="loan-detail-value">${totalInterest.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                    </div>
                    <div class="loan-detail-item">
                        <div class="loan-detail-label">APR</div>
                        <div class="loan-detail-value">${rate}%</div>
                    </div>
                    <div class="loan-detail-item">
                        <div class="loan-detail-label">Term</div>
                        <div class="loan-detail-value">${years} years</div>
                    </div>
                </div>
            `;
            detailsDiv.style.display = 'block';
        }

        /**
         * Display premium roofing options
         */
        function displayOptions(options, loanOptions, squares) {
            const optionsContainer = document.getElementById('options-container');
            
            const optionTypes = ['good', 'better', 'best'];
            const tierNames = {
                good: 'Essential',
                better: 'Premium', 
                best: 'Elite'
            };
            
            let optionsHTML = '';
            
            optionTypes.forEach((type, index) => {
                const option = options[type];
                if (!option) {
                    console.log(`Missing ${type} option`);
                    return;
                }
                
                // Use correct pricing based on squares
                let pricePerSquare;
                if (squares < 16 && option.pricePerSquareUnder16) {
                    pricePerSquare = option.pricePerSquareUnder16;
                } else {
                    pricePerSquare = option.pricePerSquare || FALLBACK_PRICING[type];
                }
                
                const totalPrice = (pricePerSquare * squares).toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });
                
                const featuredClass = type === 'better' ? 'featured' : '';
                
                // Sample features for each tier
                const features = {
                    good: [
                        'Standard architectural shingles',
                        'Basic underlayment protection',
                        'Standard ventilation system',
                        'Professional installation',
                        '10-year warranty'
                    ],
                    better: [
                        'Premium architectural shingles',
                        'Enhanced underlayment protection',
                        'Advanced ventilation system',
                        'Professional installation',
                        'Upgraded flashing & trim',
                        '20-year warranty'
                    ],
                    best: [
                        'Designer architectural shingles',
                        'Premium underlayment protection',
                        'Advanced ventilation system',
                        'Master craftsman installation',
                        'Premium flashing & trim',
                        'Gutter protection system',
                        '30-year warranty'
                    ]
                };
                
                optionsHTML += `
                    <div class="option-card ${featuredClass}">
                        <div class="option-header">
                            <div class="option-tier">${tierNames[type]} Package</div>
                            <h4 class="option-title">${option.title}</h4>
                        </div>
                        <div class="option-content">
                            <img src="${option.image || 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=200&fit=crop'}" 
                                 alt="${option.title}" 
                                 class="option-image" 
                                 onerror="this.src='https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=200&fit=crop'">
                            
                            <p class="option-description">${option.description}</p>
                            
                            <ul class="features-list">
                                ${features[type].map(feature => `
                                    <li class="feature-item">
                                        <svg class="feature-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        ${feature}
                                    </li>
                                `).join('')}
                            </ul>
                            
                            <div class="warranty-section">
                                <div class="warranty-title">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    Warranty Protection
                                </div>
                                <div class="warranty-details">${option.warranty}</div>
                            </div>
                            
                            <div class="price-section">
                                <div class="price-amount">${totalPrice}</div>
                                <div class="price-label">Total Investment</div>
                                <div class="price-breakdown">
                                    ${pricePerSquare.toLocaleString('en-US', { style: 'currency', currency: 'USD' })} per square × ${squares} squares
                                </div>
                            </div>
                            
                            ${generateFinancingSection(loanOptions, totalPrice, type)}
                        </div>
                    </div>
                `;
            });
            
            optionsContainer.innerHTML = optionsHTML;
            optionsContainer.style.display = 'block';
        }

        /**
         * Initialize the premium proposal page
         */
        async function initializeProposal() {
            console.log('Initializing premium proposal page...');
            
            if (!checkAuth()) {
                console.log('Authentication failed');
                return;
            }
            
            const proposalId = getProposalId();
            console.log('Proposal ID from URL:', proposalId);
            
            if (!proposalId) {
                displayError('No proposal ID provided in URL. Please ensure you accessed this page from a valid proposal link.');
                return;
            }
            
            try {
                console.log('Loading proposal, options, and loan options...');
                
                const [proposal, options, loanOptions] = await Promise.all([
                    loadProposal(proposalId),
                    loadRoofingOptions(),
                    loadLoanOptions()
                ]);
                
                console.log('Proposal loaded:', proposal);
                console.log('Options loaded:', options);
                console.log('Loan options loaded:', loanOptions);
                
                if (!proposal.squares || proposal.squares <= 0) {
                    throw new Error('Invalid proposal data: squares must be greater than 0');
                }
                
                displayCustomerInfo(proposal);
                displayOptions(options, loanOptions, proposal.squares);
                
                document.getElementById('loading').style.display = 'none';
                
                console.log('Premium proposal page initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize proposal:', error);
                displayError(`Failed to load proposal: ${error.message}`);
            }
        }

        // Make updateLoanDisplay available globally
        window.updateLoanDisplay = updateLoanDisplay;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing premium proposal...');
            initializeProposal();
        });
    </script>
</body>
</html> 